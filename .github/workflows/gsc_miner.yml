name: GSC Keyword Miner (Manual Trigger)

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'info'
        type: choice
        options:
        - info
        - debug

jobs:
  mine-keywords:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Ensure all dependencies from the main requirements file are installed
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # GSC Miner specific dependencies
          pip install pandas google-api-python-client google-auth-httplib2 google-auth-oauthlib
      
      - name: Set up GSC credentials
        id: gsc-creds
        run: |
          GSC_KEY_FILE="./gsc_key.json"
          echo "${{ secrets.GOOGLE_SEO_JSON }}" > $GSC_KEY_FILE
          echo "key_path=$GSC_KEY_FILE" >> $GITHUB_OUTPUT
        env:
          # Use the same secret as the SEO pusher for consistency
          GSC_CREDENTIALS: ${{ secrets.GOOGLE_SEO_JSON }}

      - name: Run GSC Miner Script
        run: python gsc_miner.py
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GSC_KEY_FILE: ${{ steps.gsc-creds.outputs.key_path }}

